#include "main_menu.h"
#include "tetris.h"
#include "glib.h"
#include <stdio.h>
#include <string.h>

// --- Module state ---
static int selected_option = 0;
static int start_level = 1;
static const char* menu_options[] = {"Start Game", "Adjust Level"};
static const int num_menu_options = 2;

// --- Pixel Art Title ---
// "TETRIS" 53x7
static const unsigned char tetris_title_pixelart[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x41, 0x41, 0x7F, 0x41, 0x41, 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x08, 0x08, 0x08, 0x08, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x12, 0x12, 0x12, 0x00, 0x00, 0xFF, 0x12, 0x12, 0x12, 0x00, 0x00, 0xFF, 0x12, 0x12, 0x12, 0xFF, 0x00, 0xFF, 0x10, 0x10, 0x10, 0x10, 0x00, 0xFF, 0x12, 0x12, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x22, 0x22, 0x22, 0x00, 0x00, 0xFF, 0x22, 0x22, 0x22, 0x00, 0x00, 0xFF, 0x22, 0x22, 0x22, 0xFF, 0x00, 0xFF, 0x20, 0x20, 0x20, 0x20, 0x00, 0xFF, 0x22, 0x22, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00, 0x7F, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x00, 0x7F, 0x48, 0x48, 0x48, 0x41, 0x00, 0x7F, 0x48, 0x48, 0x48, 0x41, 0x00, 0x41, 0x7F, 0x41, 0x7F, 0x41, 0x00, 0x7F, 0x40, 0x40, 0x40, 0x40, 0x00, 0x7F, 0x48, 0x48, 0x48, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// --- Public Functions ---

void main_menu_init(void)
{
  selected_option = 0;
  start_level = 1;
}

int main_menu_get_start_level(void)
{
  return start_level;
}

void main_menu_draw(void)
{
  GLIB_Context_t *pGlib = tetris_get_glib_context();
  GLIB_clear(pGlib);

  // Draw Title
  int title_x = (pGlib->pDisplayGeometry->xSize - 53) / 2;
  GLIB_drawBitmap(pGlib, title_x, 15, 53, 7, tetris_title_pixelart);

  // Draw Menu Options
  for (int i = 0; i < num_menu_options; i++) {
    int option_y = 60 + (i * 15);
    const char* option_text = menu_options[i];
    int text_x = (pGlib->pDisplayGeometry->xSize - (strlen(option_text) * 6)) / 2;

    if (i == selected_option) {
      GLIB_drawString(pGlib, ">", 1, text_x - 10, option_y, 0);
    }
    GLIB_drawString(pGlib, option_text, strlen(option_text), text_x, option_y, 0);

    if (i == 1) { // If it's the "Adjust Level" option
      char level_buffer[8];
      snprintf(level_buffer, sizeof(level_buffer), "<%d>", start_level);
      // Draw it to the right of the main text
      GLIB_drawString(pGlib, level_buffer, strlen(level_buffer), text_x + (strlen(option_text) * 6) + 6, option_y, 0);
    }
  }
  DMD_updateDisplay();
}

void main_menu_handle_input(sl_joystick_position_t joystick_pos, const sl_button_t *button_handle)
{
  if (joystick_pos == JOYSTICK_S) { // Down
    selected_option = (selected_option + 1) % num_menu_options;
  } else if (joystick_pos == JOYSTICK_N) { // Up
    selected_option = (selected_option - 1 + num_menu_options) % num_menu_options;
  }

  if (selected_option == 1) { // Adjust Level
    if (joystick_pos == JOYSTICK_E) { // Right
      if (start_level < 10) start_level++;
    } else if (joystick_pos == JOYSTICK_W) { // Left
      if (start_level > 1) start_level--;
    }
  }

  if (joystick_pos == JOYSTICK_C) { // Center click
    if (selected_option == 0) { // Start Game
      tetris_start_new_game(start_level);
    }
  }

  (void)button_handle; // Suppress unused parameter warning
}
